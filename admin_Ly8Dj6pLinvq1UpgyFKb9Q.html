<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù‡Ø§Ø±ÙˆÙ† | Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg: #f0f2f5; --bg2: #ffffff; --text: #1a1a2e; --text2: #666;
      --accent: #2a7d6f; --accent2: #1f5f55; --danger: #e53e3e;
      --card-border: #d0d7e0; --input-bg: #f7f8fa;
      --shadow: 0 4px 24px rgba(0,0,0,0.08); --nav-bg: #ffffff;
    }
    [data-theme="dark"] {
      --bg: #0f1117; --bg2: #1a1d27; --text: #e8eaf0; --text2: #9aa0b0;
      --accent: #3ecfb8; --accent2: #2da898; --danger: #fc5c65;
      --card-border: #2a2d3a; --input-bg: #13151f;
      --shadow: 0 4px 24px rgba(0,0,0,0.35); --nav-bg: #13151f;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'IBM Plex Sans Arabic', sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh; transition: background 0.3s, color 0.3s;
    }
    nav {
      background: var(--nav-bg);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 24px; height: 64px;
      box-shadow: 0 1px 8px rgba(0,0,0,0.06);
      position: sticky; top: 0; z-index: 100;
    }
    .nav-right { display: flex; align-items: center; gap: 14px; }
    .logo { font-size: 2rem; font-weight: 900; color: var(--accent); letter-spacing: -1px; }
    .back-link {
      font-size: 0.9rem; color: var(--text2); text-decoration: none;
      border: 1.5px solid var(--card-border); border-radius: 8px; padding: 6px 14px;
      transition: background 0.2s;
    }
    .back-link:hover { background: var(--input-bg); }
    .hamburger {
      background: none; border: none; cursor: pointer;
      display: flex; flex-direction: column; gap: 5px; padding: 6px;
    }
    .hamburger span {
      display: block; width: 26px; height: 2.5px;
      background: var(--text); border-radius: 2px; transition: background 0.3s;
    }

    main { max-width: 700px; margin: 0 auto; padding: 40px 20px 80px; }
    h1 { font-size: 1.7rem; font-weight: 900; margin-bottom: 28px; }

    /* â”€â”€â”€ Upload card â”€â”€â”€ */
    .card {
      background: var(--bg2); border: 1.5px solid var(--card-border);
      border-radius: 18px; padding: 30px; box-shadow: var(--shadow);
      margin-bottom: 36px;
    }
    .card h2 { font-size: 1.15rem; font-weight: 900; margin-bottom: 22px; color: var(--accent); }

    .field { margin-bottom: 20px; }
    label { display: block; font-weight: 700; font-size: 0.92rem; color: var(--text2); margin-bottom: 7px; }
    input[type="text"] {
      width: 100%; padding: 11px 15px;
      background: var(--input-bg); border: 1.5px solid var(--card-border);
      border-radius: 10px; font-family: 'IBM Plex Sans Arabic', sans-serif;
      font-size: 1rem; color: var(--text); outline: none;
      transition: border-color 0.2s;
    }
    input[type="text"]:focus { border-color: var(--accent); }

    .file-drop {
      border: 2.5px dashed var(--card-border);
      border-radius: 12px; padding: 24px 16px;
      text-align: center; cursor: pointer; position: relative;
      transition: border-color 0.2s, background 0.2s;
    }
    .file-drop:hover, .file-drop.over {
      border-color: var(--accent);
      background: rgba(42,125,111,0.04);
    }
    .file-drop input[type="file"] {
      position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
    }
    .drop-icon { font-size: 2.2rem; }
    .drop-label { font-size: 0.9rem; color: var(--text2); margin-top: 6px; }
    .drop-chosen { font-size: 0.88rem; font-weight: 700; color: var(--accent); margin-top: 5px; display: none; }

    .preview-img {
      width: 100%; max-height: 180px; object-fit: cover;
      border-radius: 10px; margin-top: 14px;
      border: 1.5px solid var(--card-border); display: none;
    }

    .size-hint { font-size: 0.8rem; color: var(--text2); margin-top: 6px; }
    .size-warn { color: var(--danger); }

    .publish-btn {
      width: 100%; padding: 14px;
      background: var(--accent); color: #fff; border: none;
      border-radius: 12px; font-family: 'IBM Plex Sans Arabic', sans-serif;
      font-size: 1.1rem; font-weight: 700; cursor: pointer;
      transition: background 0.2s, opacity 0.2s;
      margin-top: 8px;
    }
    .publish-btn:hover { background: var(--accent2); }
    .publish-btn:disabled { opacity: 0.55; cursor: not-allowed; }

    /* Progress bar */
    .progress-wrap { margin-top: 14px; display: none; }
    .progress-bar-bg {
      background: var(--card-border); border-radius: 99px; height: 8px; overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%; background: var(--accent);
      border-radius: 99px; width: 0%; transition: width 0.3s;
    }
    .progress-label { font-size: 0.85rem; color: var(--text2); margin-top: 6px; text-align: center; }

    /* Alert */
    .alert {
      border-radius: 10px; padding: 13px 18px; font-size: 0.95rem;
      font-weight: 700; margin-top: 14px; display: none;
    }
    .alert.success { background: rgba(42,125,111,0.12); color: var(--accent); }
    .alert.error   { background: rgba(229,62,62,0.1);  color: var(--danger); }

    /* â”€â”€â”€ Font list â”€â”€â”€ */
    .font-list { display: flex; flex-direction: column; gap: 14px; }
    .font-item {
      background: var(--bg2); border: 1.5px solid var(--card-border);
      border-radius: 14px; overflow: hidden; box-shadow: var(--shadow);
      display: flex; align-items: center; gap: 0;
    }
    .font-item img {
      width: 120px; height: 72px; object-fit: cover; flex-shrink: 0;
    }
    .font-item-info { padding: 0 16px; flex: 1; }
    .font-item-name { font-weight: 700; font-size: 1rem; }
    .font-item-date { font-size: 0.8rem; color: var(--text2); margin-top: 3px; }
    .delete-btn {
      background: none; border: none; cursor: pointer;
      color: var(--danger); font-size: 1.4rem;
      padding: 12px 16px; transition: background 0.2s; flex-shrink: 0;
    }
    .delete-btn:hover { background: rgba(229,62,62,0.08); }
    .list-empty { color: var(--text2); text-align: center; padding: 30px 0; }
    .list-loader { text-align: center; padding: 30px 0; color: var(--text2); }

    @media (max-width: 500px) {
      .font-item img { width: 90px; height: 56px; }
      .font-item-info { padding: 0 10px; }
    }
  </style>
</head>
<body>
<nav>
  <span class="logo">Ù‡ÙØ§Ø±ÙˆÙ†</span>
  <div class="nav-right">
    <a href="index.html" class="back-link">â† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <button class="hamburger" id="themeToggle" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹">
      <span></span><span></span><span></span>
    </button>
  </div>
</nav>

<main>
  <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>

  <!-- Upload form -->
  <div class="card">
    <h2>â• Ù†Ø´Ø± Ø®Ø· Ø¬Ø¯ÙŠØ¯</h2>

    <div class="field">
      <label for="fontName">Ø§Ø³Ù… Ø§Ù„Ø®Ø·</label>
      <input type="text" id="fontName" placeholder="Ù…Ø«Ø§Ù„: Ø®Ø· Ø±Ù…Ø¶Ø§Ù† 2026" />
    </div>

    <div class="field">
      <label>Ø¨ÙˆØ³ØªØ± Ø§Ù„Ø®Ø· (ØµÙˆØ±Ø©)</label>
      <div class="file-drop" id="posterDrop">
        <input type="file" id="posterFile" accept="image/*" />
        <div class="drop-icon">ğŸ–¼ï¸</div>
        <div class="drop-label">Ø§Ø¶ØºØ· Ø£Ùˆ Ø§Ø³Ø­Ø¨ ØµÙˆØ±Ø© Ù‡Ù†Ø§</div>
        <div class="drop-chosen" id="posterChosen"></div>
      </div>
      <img id="posterPreview" class="preview-img" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙˆØ³ØªØ±"/>
      <div class="size-hint" id="posterSize"></div>
    </div>

    <div class="field">
      <label>Ù…Ù„Ù Ø§Ù„Ø®Ø· (TTF / OTF / ZIP)</label>
      <div class="file-drop" id="fileDrop">
        <input type="file" id="fontFile" accept=".ttf,.otf,.woff,.woff2,.zip" />
        <div class="drop-icon">ğŸ“</div>
        <div class="drop-label">Ø§Ø¶ØºØ· Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ù…Ù„Ù Ø§Ù„Ø®Ø· Ù‡Ù†Ø§</div>
        <div class="drop-chosen" id="fileChosen"></div>
      </div>
      <div class="size-hint" id="fileSize"></div>
    </div>

    <div class="progress-wrap" id="progressWrap">
      <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill"></div></div>
      <div class="progress-label" id="progressLabel">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹â€¦</div>
    </div>

    <div class="alert" id="alertBox"></div>

    <button class="publish-btn" id="publishBtn">Ù†Ø´Ø± Ø§Ù„Ø®Ø·</button>
  </div>

  <!-- Fonts list -->
  <div class="card">
    <h2>ğŸ“‹ Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø©</h2>
    <div id="fontList" class="list-loader">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div>
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, getDocs,
    deleteDoc, doc, orderBy, query, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAIGBt0B6-Tl04e1TNOnprJ-WL_7PQFrM4",
    authDomain: "harron-bot.firebaseapp.com",
    projectId: "harron-bot",
    storageBucket: "harron-bot.firebasestorage.app",
    messagingSenderId: "717376969000",
    appId: "1:717376969000:web:251e20d075873b0c28581d"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* â”€â”€ Supabase Storage â”€â”€ */
  const SUPABASE_URL = 'https://jtgyechlkyblkxqdijnq.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_LOlSx3eIcpDTGEyOZBm9SQ_zO0Bo1kB';
  const BUCKET = 'HAROON';

  async function uploadToSupabase(file, folder) {
    const fileName = `${folder}/${Date.now()}_${file.name}`;
    const res = await fetch(`${SUPABASE_URL}/storage/v1/object/${BUCKET}/${fileName}`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': file.type || 'application/octet-stream',
        'x-upsert': 'true'
      },
      body: file
    });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.message || 'ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù');
    }
    return `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${fileName}`;
  }

  /* â”€â”€ Dark mode â”€â”€ */
  const applyTheme = t => document.documentElement.setAttribute('data-theme', t);
  applyTheme(localStorage.getItem('theme') || 'light');
  document.getElementById('themeToggle').addEventListener('click', () => {
    const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    applyTheme(next); localStorage.setItem('theme', next);
  });

  function fmtSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes/1024).toFixed(1) + ' KB';
    return (bytes/1048576).toFixed(2) + ' MB';
  }

  /* â”€â”€ File drop helpers â”€â”€ */
  function setupDrop(dropId, inputId, chosenId, sizeId, onFile) {
    const drop   = document.getElementById(dropId);
    const input  = document.getElementById(inputId);
    const chosen = document.getElementById(chosenId);
    const sizeEl = document.getElementById(sizeId);

    const handleFile = f => {
      chosen.textContent = f.name;
      chosen.style.display = 'block';
      sizeEl.textContent = `Ø§Ù„Ø­Ø¬Ù…: ${fmtSize(f.size)}`;
      onFile(f);
    };

    input.addEventListener('change', () => { if (input.files[0]) handleFile(input.files[0]); });
    drop.addEventListener('dragover',  e => { e.preventDefault(); drop.classList.add('over'); });
    drop.addEventListener('dragleave', ()  => drop.classList.remove('over'));
    drop.addEventListener('drop', e => {
      e.preventDefault(); drop.classList.remove('over');
      if (e.dataTransfer.files[0]) { input.files = e.dataTransfer.files; handleFile(e.dataTransfer.files[0]); }
    });
  }

  let posterFile = null, fontFile = null;

  setupDrop('posterDrop','posterFile','posterChosen','posterSize', f => {
    posterFile = f;
    const preview = document.getElementById('posterPreview');
    preview.src = URL.createObjectURL(f);
    preview.style.display = 'block';
  });

  setupDrop('fileDrop','fontFile','fileChosen','fileSize', f => { fontFile = f; });

  /* â”€â”€ Alert helper â”€â”€ */
  function showAlert(msg, type) {
    const el = document.getElementById('alertBox');
    el.textContent = msg;
    el.className = `alert ${type}`;
    el.style.display = 'block';
    if (type === 'success') setTimeout(() => el.style.display = 'none', 4000);
  }

  /* â”€â”€ Progress â”€â”€ */
  function setProgress(pct, label) {
    document.getElementById('progressWrap').style.display = 'block';
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('progressLabel').textContent = label;
  }
  function hideProgress() { document.getElementById('progressWrap').style.display = 'none'; }

  /* â”€â”€ Publish â”€â”€ */
  document.getElementById('publishBtn').addEventListener('click', async () => {
    const name = document.getElementById('fontName').value.trim();
    if (!name)       { showAlert('âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø®Ø·', 'error'); return; }
    if (!posterFile) { showAlert('âš ï¸ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø§Ù„Ø¨ÙˆØ³ØªØ±', 'error'); return; }
    if (!fontFile)   { showAlert('âš ï¸ Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ø®Ø·', 'error'); return; }

    const btn = document.getElementById('publishBtn');
    btn.disabled = true;
    document.getElementById('alertBox').style.display = 'none';

    try {
      setProgress(20, 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆØ³ØªØ±â€¦');
      const posterURL = await uploadToSupabase(posterFile, 'posters');

      setProgress(55, 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø®Ø·â€¦');
      const fontURL = await uploadToSupabase(fontFile, 'fonts');

      setProgress(85, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebaseâ€¦');
      await addDoc(collection(db, 'fonts'), {
        name,
        posterBase64: posterURL,
        fileBase64: fontURL,
        fileName: fontFile.name,
        createdAt: serverTimestamp()
      });

      setProgress(100, 'ØªÙ… Ø§Ù„Ø±ÙØ¹!');
      setTimeout(hideProgress, 1500);
      showAlert('âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø®Ø· Ø¨Ù†Ø¬Ø§Ø­!', 'success');

      // reset
      document.getElementById('fontName').value = '';
      document.getElementById('posterPreview').style.display = 'none';
      ['posterChosen','fileChosen'].forEach(id => { document.getElementById(id).style.display = 'none'; });
      ['posterSize','fileSize'].forEach(id => { document.getElementById(id).textContent = ''; });
      posterFile = null; fontFile = null;

      loadFontList();
    } catch(e) {
      hideProgress();
      showAlert('âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: ' + e.message, 'error');
      console.error(e);
    } finally {
      btn.disabled = false;
    }
  });

  /* â”€â”€ Font list â”€â”€ */
  async function loadFontList() {
    const el = document.getElementById('fontList');
    el.className = 'list-loader';
    el.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦';
    try {
      const snap = await getDocs(query(collection(db, 'fonts'), orderBy('createdAt','desc')));
      if (snap.empty) {
        el.className = 'list-empty';
        el.innerHTML = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·ÙˆØ· Ù…Ù†Ø´ÙˆØ±Ø© Ø¨Ø¹Ø¯';
        return;
      }
      el.className = 'font-list';
      el.innerHTML = '';
      snap.forEach(d => {
        const data = d.data();
        const ts   = data.createdAt?.toDate?.();
        const date = ts ? ts.toLocaleDateString('ar-EG') : 'â€”';
        const item = document.createElement('div');
        item.className = 'font-item';
        item.innerHTML = `
          <img src="${data.posterBase64}" alt="${data.name}" />
          <div class="font-item-info">
            <div class="font-item-name">${data.name}</div>
            <div class="font-item-date">${date}</div>
          </div>
          <button class="delete-btn" data-id="${d.id}" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>`;
        el.appendChild(item);
      });

      el.addEventListener('click', async e => {
        const btn = e.target.closest('.delete-btn');
        if (!btn) return;
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø®Ø· Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) return;
        try {
          await deleteDoc(doc(db, 'fonts', btn.dataset.id));
          btn.closest('.font-item').remove();
          if (!el.querySelector('.font-item')) {
            el.className = 'list-empty';
            el.innerHTML = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·ÙˆØ· Ù…Ù†Ø´ÙˆØ±Ø© Ø¨Ø¹Ø¯';
          }
        } catch(e) {
          alert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ' + e.message);
        }
      });
    } catch(e) {
      el.className = 'list-empty';
      el.innerHTML = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + e.message;
    }
  }

  loadFontList();
</script>
</body>
</html>
