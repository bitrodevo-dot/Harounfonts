<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù‡Ø§Ø±ÙˆÙ† | Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ù…ØªÙˆÙØ±Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg: #f0f2f5; --bg2: #ffffff; --text: #1a1a2e; --text2: #666;
      --accent: #2a7d6f; --card-border: #d0d7e0;
      --shadow: 0 4px 24px rgba(0,0,0,0.08); --nav-bg: #ffffff;
    }
    [data-theme="dark"] {
      --bg: #0f1117; --bg2: #1a1d27; --text: #e8eaf0; --text2: #9aa0b0;
      --accent: #3ecfb8; --card-border: #2a2d3a;
      --shadow: 0 4px 24px rgba(0,0,0,0.35); --nav-bg: #13151f;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'IBM Plex Sans Arabic', sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh; transition: background 0.3s, color 0.3s;
    }

    /* NAV */
    nav {
      background: var(--nav-bg);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 24px; height: 64px;
      box-shadow: 0 1px 8px rgba(0,0,0,0.06);
      position: sticky; top: 0; z-index: 100;
      transition: background 0.3s;
    }
    .logo { font-size: 2rem; font-weight: 900; color: var(--accent); letter-spacing: -1px; }
    .theme-btn {
      background: none; border: none; cursor: pointer;
      width: 42px; height: 42px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem; transition: background 0.2s, transform 0.4s;
    }
    .theme-btn:hover { background: rgba(128,128,128,0.1); transform: rotate(20deg); }

    /* SEARCH AREA */
    .search-area {
      max-width: 720px; margin: 36px auto 0; padding: 0 20px;
    }
    .search-wrap { position: relative; display: flex; align-items: center; }
    .search-icon {
      position: absolute; right: 16px; font-size: 1.1rem;
      color: var(--text2); pointer-events: none;
    }
    #searchInput {
      width: 100%; padding: 14px 48px 14px 48px;
      background: var(--bg2); border: 2px solid var(--card-border);
      border-radius: 16px; font-family: 'IBM Plex Sans Arabic', sans-serif;
      font-size: 1rem; color: var(--text); outline: none;
      box-shadow: var(--shadow); transition: border-color 0.2s, box-shadow 0.2s;
    }
    #searchInput::placeholder { color: var(--text2); }
    #searchInput:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(42,125,111,0.1);
    }
    #clearBtn {
      position: absolute; left: 14px; background: none; border: none;
      cursor: pointer; color: var(--text2); font-size: 1rem;
      display: none; width: 28px; height: 28px; border-radius: 50%;
      align-items: center; justify-content: center;
      transition: background 0.2s, color 0.2s;
    }
    #clearBtn:hover { background: rgba(128,128,128,0.15); color: var(--text); }

    /* FILTERS */
    .filters { display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap; }
    .filter-btn {
      background: var(--bg2); border: 1.5px solid var(--card-border);
      border-radius: 99px; padding: 6px 18px;
      font-family: 'IBM Plex Sans Arabic', sans-serif;
      font-size: 0.85rem; font-weight: 700; color: var(--text2);
      cursor: pointer; transition: all 0.2s;
    }
    .filter-btn:hover { border-color: var(--accent); color: var(--accent); }
    .filter-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* RESULTS */
    .results-count {
      font-size: 0.85rem; color: var(--text2);
      margin-top: 10px; min-height: 20px;
    }

    /* MAIN GRID */
    main { max-width: 1100px; margin: 0 auto; padding: 32px 20px 80px; }
    h1 {
      text-align: center;
      font-size: clamp(1.8rem, 5vw, 2.8rem);
      font-weight: 900; margin-bottom: 16px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 28px; margin-top: 28px;
    }
    .card {
      background: var(--bg2); border: 1.5px solid var(--card-border);
      border-radius: 18px; overflow: hidden; box-shadow: var(--shadow);
      transition: transform 0.22s, box-shadow 0.22s;
      animation: fadeUp 0.4s ease both;
    }
    .card.hidden { display: none; }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(18px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .card:hover { transform: translateY(-5px); box-shadow: 0 14px 40px rgba(0,0,0,0.13); }
    .card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; display: block; }
    .card-body {
      padding: 16px 20px;
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
    }
    .font-name { font-size: 1.05rem; font-weight: 700; }
    .font-name mark {
      background: rgba(42,125,111,0.18); color: var(--accent);
      border-radius: 3px; padding: 0 2px;
    }
    .download-btn {
      background: var(--accent); color: #fff;
      border: none; border-radius: 10px; padding: 9px 18px;
      font-family: 'IBM Plex Sans Arabic', sans-serif; font-size: 0.9rem; font-weight: 700;
      cursor: pointer; transition: opacity 0.2s, transform 0.15s; white-space: nowrap;
      text-decoration: none; display: inline-block;
    }
    .download-btn:hover { opacity: 0.85; transform: scale(1.04); }

    /* NO RESULTS */
    .no-results {
      text-align: center; color: var(--text2);
      padding: 70px 0; display: none;
    }
    .no-results .icon { font-size: 3.5rem; margin-bottom: 14px; }
    .no-results p { font-size: 1.1rem; }
    .no-results strong { color: var(--accent); }

    .empty { text-align: center; color: var(--text2); font-size: 1.2rem; padding: 80px 0; }
    .loader { display: flex; justify-content: center; align-items: center; height: 200px; }
    .spinner {
      width: 44px; height: 44px; border: 4px solid var(--card-border);
      border-top-color: var(--accent); border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 460px) {
      .card-body { flex-direction: column; align-items: flex-start; }
      .download-btn { width: 100%; text-align: center; }
    }
  </style>
</head>
<body>
<nav>
  <span class="logo">Ù‡ÙØ§Ø±ÙˆÙ†</span>
  <button class="theme-btn" id="themeToggle" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹">ğŸŒ™</button>
</nav>

<div class="search-area">
  <div class="search-wrap">
    <span class="search-icon">ğŸ”</span>
    <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø®Ø·â€¦" autocomplete="off"/>
    <button id="clearBtn">âœ•</button>
  </div>
  <div class="filters" id="filters">
    <button class="filter-btn active" data-filter="all">ğŸ—‚ Ø§Ù„ÙƒÙ„</button>
  </div>
  <div class="results-count" id="resultsCount"></div>
</div>

<main>
  <h1>Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ù…ØªÙˆÙØ±Ø©</h1>
  <div id="content">
    <div class="loader"><div class="spinner"></div></div>
  </div>
  <div class="no-results" id="noResults">
    <div class="icon">ğŸ”</div>
    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù€ <strong id="searchTerm"></strong></p>
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, getDocs, orderBy, query }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAIGBt0B6-Tl04e1TNOnprJ-WL_7PQFrM4",
    authDomain: "harron-bot.firebaseapp.com",
    projectId: "harron-bot",
    storageBucket: "harron-bot.firebasestorage.app",
    messagingSenderId: "717376969000",
    appId: "1:717376969000:web:251e20d075873b0c28581d"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* â”€â”€ Theme â”€â”€ */
  const themeBtn = document.getElementById('themeToggle');
  const applyTheme = t => {
    document.documentElement.setAttribute('data-theme', t);
    themeBtn.textContent = t === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
  };
  applyTheme(localStorage.getItem('theme') || 'light');
  themeBtn.addEventListener('click', () => {
    const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    applyTheme(next); localStorage.setItem('theme', next);
  });

  /* â”€â”€ Search â”€â”€ */
  const searchInput  = document.getElementById('searchInput');
  const clearBtn     = document.getElementById('clearBtn');
  const resultsCount = document.getElementById('resultsCount');
  const noResults    = document.getElementById('noResults');
  const searchTermEl = document.getElementById('searchTerm');
  const filtersEl    = document.getElementById('filters');

  let activeFilter = 'all';

  function escapeRe(s) { return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

  function highlight(text, q) {
    if (!q) return text;
    return text.replace(new RegExp(`(${escapeRe(q)})`, 'gi'), '<mark>$1</mark>');
  }

  function doSearch() {
    const q = searchInput.value.trim();
    clearBtn.style.display = q ? 'flex' : 'none';

    const grid = document.getElementById('grid');
    if (!grid) return;

    let visible = 0;
    grid.querySelectorAll('.card').forEach(card => {
      const name = card.dataset.name || '';
      const cat  = card.dataset.cat  || '';
      const matchQ = q === '' || name.includes(q);
      const matchF = activeFilter === 'all' || cat === activeFilter;

      if (matchQ && matchF) {
        card.classList.remove('hidden');
        const el = card.querySelector('.font-name');
        if (el) el.innerHTML = highlight(name, q);
        visible++;
      } else {
        card.classList.add('hidden');
      }
    });

    resultsCount.textContent = (q || activeFilter !== 'all') ? `${visible} Ø®Ø·` : '';
    noResults.style.display = visible === 0 && q ? 'block' : 'none';
    if (q) searchTermEl.textContent = q;
  }

  searchInput.addEventListener('input', doSearch);
  clearBtn.addEventListener('click', () => { searchInput.value = ''; doSearch(); searchInput.focus(); });

  filtersEl.addEventListener('click', e => {
    const btn = e.target.closest('.filter-btn');
    if (!btn) return;
    filtersEl.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    activeFilter = btn.dataset.filter;
    doSearch();
  });

  /* â”€â”€ Load Fonts â”€â”€ */
  async function loadFonts() {
    const content = document.getElementById('content');
    try {
      const snap = await getDocs(query(collection(db, 'fonts'), orderBy('createdAt','desc')));
      if (snap.empty) {
        content.innerHTML = '<p class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·ÙˆØ· Ù…Ù†Ø´ÙˆØ±Ø© Ø¨Ø¹Ø¯</p>';
        return;
      }

      const grid = document.createElement('div');
      grid.className = 'grid'; grid.id = 'grid';

      const cats = new Set();

      snap.forEach((docSnap, i) => {
        const d = docSnap.data();

        // ØªØµÙ†ÙŠÙ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ø®Ø·
        let cat = 'Ø£Ø®Ø±Ù‰';
        const n = d.name.toLowerCase();
        if (n.includes('Ø±Ù…Ø¶Ø§Ù†') || n.includes('ramadan')) cat = 'Ø±Ù…Ø¶Ø§Ù†';
        else if (n.includes('Ø¹ÙŠØ¯') || n.includes('eid'))   cat = 'Ø¹ÙŠØ¯';
        else if (n.includes('ÙƒÙ„Ø§Ø³ÙŠÙƒ') || n.includes('classic')) cat = 'ÙƒÙ„Ø§Ø³ÙŠÙƒ';
        else if (n.includes('Ø­Ø¯ÙŠØ«') || n.includes('modern')) cat = 'Ø­Ø¯ÙŠØ«';
        cats.add(cat);

        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.name = d.name;
        card.dataset.cat  = cat;
        card.style.animationDelay = `${i * 0.07}s`;
        card.innerHTML = `
          <img src="${d.posterBase64}" alt="${d.name}" loading="lazy"/>
          <div class="card-body">
            <span class="font-name">${d.name}</span>
            <a class="download-btn" href="${d.fileBase64}" download="${d.fileName}" target="_blank">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„</a>
          </div>`;
        grid.appendChild(card);
      });

      content.innerHTML = '';
      content.appendChild(grid);

      // Ø£Ø¶Ù Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„ØªØ±
      cats.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.dataset.filter = cat;
        btn.textContent = cat;
        filtersEl.appendChild(btn);
      });

    } catch(e) {
      content.innerHTML = '<p class="empty">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>';
      console.error(e);
    }
  }

  loadFonts();
</script>
</body>
</html>
