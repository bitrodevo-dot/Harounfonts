<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>هارون | الخطوط المتوفرة</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg: #f0f2f5; --bg2: #ffffff; --text: #1a1a2e; --text2: #666;
      --accent: #2a7d6f; --card-border: #d0d7e0;
      --shadow: 0 4px 24px rgba(0,0,0,0.08); --nav-bg: #ffffff;
    }
    [data-theme="dark"] {
      --bg: #0f1117; --bg2: #1a1d27; --text: #e8eaf0; --text2: #9aa0b0;
      --accent: #3ecfb8; --card-border: #2a2d3a;
      --shadow: 0 4px 24px rgba(0,0,0,0.35); --nav-bg: #13151f;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'IBM Plex Sans Arabic', sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh; transition: background 0.3s, color 0.3s;
    }

    /* NAV */
    nav {
      background: var(--nav-bg);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 24px; height: 64px;
      box-shadow: 0 1px 8px rgba(0,0,0,0.06);
      position: sticky; top: 0; z-index: 100;
      transition: background 0.3s;
    }
    .logo { font-size: 2rem; font-weight: 900; color: var(--accent); letter-spacing: -1px; }
    .theme-btn {
      background: none; border: none; cursor: pointer;
      width: 42px; height: 42px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s, transform 0.4s; color: var(--text);
    }
    .theme-btn:hover { background: rgba(128,128,128,0.1); transform: rotate(20deg); }
    .theme-btn svg { width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; transition: opacity 0.3s; }

    /* SEARCH */
    .search-area { max-width: 680px; margin: 36px auto 0; padding: 0 20px; }
    .search-wrap { position: relative; display: flex; align-items: center; }
    .search-icon {
      position: absolute; right: 16px; pointer-events: none;
      color: var(--text2); display: flex; align-items: center;
    }
    .search-icon svg { width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; }
    #searchInput {
      width: 100%; padding: 14px 50px 14px 50px;
      background: var(--bg2); border: 2px solid var(--card-border);
      border-radius: 16px; font-family: 'IBM Plex Sans Arabic', sans-serif;
      font-size: 1rem; color: var(--text); outline: none;
      box-shadow: var(--shadow); transition: border-color 0.2s, box-shadow 0.2s;
    }
    #searchInput::placeholder { color: var(--text2); }
    #searchInput:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(42,125,111,0.1);
    }
    #clearBtn {
      position: absolute; left: 12px; background: none; border: none;
      cursor: pointer; color: var(--text2);
      width: 30px; height: 30px; border-radius: 50%;
      display: none; align-items: center; justify-content: center;
      transition: background 0.2s, color 0.2s;
    }
    #clearBtn:hover { background: rgba(128,128,128,0.15); color: var(--text); }
    #clearBtn svg { width: 14px; height: 14px; fill: none; stroke: currentColor; stroke-width: 2.5; stroke-linecap: round; }

    .results-count { font-size: 0.85rem; color: var(--text2); margin-top: 10px; min-height: 20px; }

    /* GRID */
    main { max-width: 1100px; margin: 0 auto; padding: 32px 20px 80px; }
    h1 {
      text-align: center;
      font-size: clamp(1.8rem, 5vw, 2.8rem);
      font-weight: 900; margin-bottom: 16px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 28px; margin-top: 28px;
    }
    .card {
      background: var(--bg2); border: 1.5px solid var(--card-border);
      border-radius: 18px; overflow: hidden; box-shadow: var(--shadow);
      transition: transform 0.22s, box-shadow 0.22s;
      animation: fadeUp 0.4s ease both;
    }
    .card.hidden { display: none; }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(18px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .card:hover { transform: translateY(-5px); box-shadow: 0 14px 40px rgba(0,0,0,0.13); }
    .card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; display: block; }
    .card-body {
      padding: 16px 20px;
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
    }
    .font-name { font-size: 1.05rem; font-weight: 700; }
    .font-name mark {
      background: rgba(42,125,111,0.18); color: var(--accent);
      border-radius: 3px; padding: 0 2px;
    }
    .download-btn {
      background: var(--accent); color: #fff;
      border: none; border-radius: 10px; padding: 9px 16px;
      font-family: 'IBM Plex Sans Arabic', sans-serif; font-size: 0.9rem; font-weight: 700;
      cursor: pointer; transition: opacity 0.2s, transform 0.15s; white-space: nowrap;
      text-decoration: none; display: inline-flex; align-items: center; gap: 7px;
    }
    .download-btn:hover { opacity: 0.85; transform: scale(1.04); }
    .download-btn svg { width: 15px; height: 15px; fill: none; stroke: currentColor; stroke-width: 2.2; stroke-linecap: round; stroke-linejoin: round; }

    /* NO RESULTS */
    .no-results {
      text-align: center; color: var(--text2);
      padding: 70px 0; display: none;
    }
    .no-results svg { width: 52px; height: 52px; fill: none; stroke: var(--text2); stroke-width: 1.5; margin-bottom: 16px; }
    .no-results p { font-size: 1.1rem; }
    .no-results strong { color: var(--accent); }

    .empty { text-align: center; color: var(--text2); font-size: 1.2rem; padding: 80px 0; }
    .loader { display: flex; justify-content: center; align-items: center; height: 200px; }
    .spinner {
      width: 44px; height: 44px; border: 4px solid var(--card-border);
      border-top-color: var(--accent); border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 460px) {
      .card-body { flex-direction: column; align-items: flex-start; }
      .download-btn { width: 100%; justify-content: center; }
    }

    /* MODAL */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 999;
      background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center;
      padding: 20px;
      opacity: 0; pointer-events: none;
      transition: opacity 0.25s;
    }
    .modal-overlay.open { opacity: 1; pointer-events: all; }
    .modal {
      background: var(--bg2); border-radius: 20px;
      padding: 32px 28px; max-width: 380px; width: 100%;
      box-shadow: 0 24px 64px rgba(0,0,0,0.25);
      transform: translateY(20px); transition: transform 0.25s;
      text-align: center;
    }
    .modal-overlay.open .modal { transform: translateY(0); }
    .modal-icon {
      width: 56px; height: 56px; background: rgba(42,125,111,0.1);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      margin: 0 auto 18px;
    }
    .modal-icon svg { width: 26px; height: 26px; fill: none; stroke: var(--accent); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    .modal h3 { font-size: 1.15rem; font-weight: 900; margin-bottom: 8px; }
    .modal-font-name { color: var(--accent); font-weight: 700; font-size: 0.95rem; margin-bottom: 20px; }
    .modal-channel {
      display: inline-flex; align-items: center; gap: 8px;
      background: rgba(42,125,111,0.08); border: 1.5px solid rgba(42,125,111,0.2);
      border-radius: 10px; padding: 9px 18px; margin-bottom: 22px;
      text-decoration: none; color: var(--accent); font-weight: 700; font-size: 0.92rem;
      transition: background 0.2s;
    }
    .modal-channel:hover { background: rgba(42,125,111,0.16); }
    .modal-channel svg { width: 18px; height: 18px; fill: var(--accent); flex-shrink: 0; }
    .modal-actions { display: flex; gap: 10px; }
    .modal-cancel {
      flex: 1; padding: 12px; border-radius: 12px;
      background: var(--bg); border: 1.5px solid var(--card-border);
      font-family: 'IBM Plex Sans Arabic', sans-serif; font-size: 0.95rem; font-weight: 700;
      color: var(--text2); cursor: pointer; transition: background 0.2s;
    }
    .modal-cancel:hover { background: var(--card-border); }
    .modal-confirm {
      flex: 1; padding: 12px; border-radius: 12px;
      background: var(--accent); border: none;
      font-family: 'IBM Plex Sans Arabic', sans-serif; font-size: 0.95rem; font-weight: 700;
      color: #fff; cursor: pointer; transition: opacity 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 7px;
      text-decoration: none;
    }
    .modal-confirm:hover { opacity: 0.85; }
    .modal-confirm svg { width: 15px; height: 15px; fill: none; stroke: currentColor; stroke-width: 2.2; stroke-linecap: round; stroke-linejoin: round; }
    .modal-credit { font-size: 0.75rem; color: var(--text2); margin-top: 16px; }
    .modal-credit a { color: var(--accent); text-decoration: none; font-weight: 700; }
    .modal-credit a:hover { text-decoration: underline; }
  </style>
</head>
<body>
<nav>
  <span class="logo">هَارون</span>
  <button class="theme-btn" id="themeToggle" title="تبديل الوضع">
    <!-- sun icon (shown in dark mode) -->
    <svg id="iconSun" viewBox="0 0 24 24" style="display:none">
      <circle cx="12" cy="12" r="5"/>
      <line x1="12" y1="1" x2="12" y2="3"/>
      <line x1="12" y1="21" x2="12" y2="23"/>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
      <line x1="1" y1="12" x2="3" y2="12"/>
      <line x1="21" y1="12" x2="23" y2="12"/>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
    </svg>
    <!-- moon icon (shown in light mode) -->
    <svg id="iconMoon" viewBox="0 0 24 24">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
    </svg>
  </button>
</nav>

<div class="search-area">
  <div class="search-wrap">
    <span class="search-icon">
      <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    </span>
    <input type="text" id="searchInput" placeholder="ابحث عن اسم الخط…" autocomplete="off"/>
    <button id="clearBtn" title="مسح">
      <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div class="results-count" id="resultsCount"></div>
</div>

<main>
  <h1>الخطوط المتوفرة</h1>
  <div id="content">
    <div class="loader"><div class="spinner"></div></div>
  </div>
  <div class="no-results" id="noResults">
    <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
    <p>لا توجد نتائج لـ <strong id="searchTerm"></strong></p>
  </div>
</main>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-icon">
      <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    </div>
    <h3>أنت متأكد من تحميل الخط؟</h3>
    <div class="modal-font-name" id="modalFontName"></div>
    <a href="https://t.me/Quranfont1" target="_blank" class="modal-channel">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.447 1.394c-.16.16-.295.295-.605.295l.213-3.053 5.56-5.023c.242-.213-.054-.333-.373-.12L8.32 13.617l-2.96-.924c-.643-.204-.657-.643.136-.953l11.57-4.461c.537-.194 1.006.131.828.942z"/></svg>
      قناتنا على تيليجرام
    </a>
    <div class="modal-actions">
      <button class="modal-cancel" id="modalCancel">إلغاء</button>
      <a class="modal-confirm" id="modalConfirm" href="#" download>
        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        تحميل
      </a>
    </div>
    <div class="modal-credit">تمت برمجة هذا الموقع بواسطة <a href="https://t.me/bitroMW" target="_blank">BITRO</a></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, getDocs, orderBy, query }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAIGBt0B6-Tl04e1TNOnprJ-WL_7PQFrM4",
    authDomain: "harron-bot.firebaseapp.com",
    projectId: "harron-bot",
    storageBucket: "harron-bot.firebasestorage.app",
    messagingSenderId: "717376969000",
    appId: "1:717376969000:web:251e20d075873b0c28581d"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* ── Theme ── */
  const themeBtn = document.getElementById('themeToggle');
  const iconSun  = document.getElementById('iconSun');
  const iconMoon = document.getElementById('iconMoon');

  const applyTheme = t => {
    document.documentElement.setAttribute('data-theme', t);
    iconSun.style.display  = t === 'dark' ? 'block' : 'none';
    iconMoon.style.display = t === 'dark' ? 'none'  : 'block';
  };
  applyTheme(localStorage.getItem('theme') || 'light');
  themeBtn.addEventListener('click', () => {
    const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    applyTheme(next); localStorage.setItem('theme', next);
  });

  /* ── Modal ── */
  const modalOverlay  = document.getElementById('modalOverlay');
  const modalCancel   = document.getElementById('modalCancel');
  const modalConfirm  = document.getElementById('modalConfirm');
  const modalFontName = document.getElementById('modalFontName');

  function openModal(name, href, filename) {
    modalFontName.textContent = name;
    modalConfirm.href = href;
    modalConfirm.download = filename;
    modalOverlay.classList.add('open');
  }
  function closeModal() { modalOverlay.classList.remove('open'); }

  modalCancel.addEventListener('click', closeModal);
  modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) closeModal(); });
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
  modalConfirm.addEventListener('click', () => setTimeout(closeModal, 300));

  /* ── Search ── */
  const searchInput  = document.getElementById('searchInput');
  const clearBtn     = document.getElementById('clearBtn');
  const resultsCount = document.getElementById('resultsCount');
  const noResults    = document.getElementById('noResults');
  const searchTermEl = document.getElementById('searchTerm');

  function escapeRe(s) { return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
  function highlight(text, q) {
    if (!q) return text;
    return text.replace(new RegExp(`(${escapeRe(q)})`, 'gi'), '<mark>$1</mark>');
  }

  function doSearch() {
    const q = searchInput.value.trim();
    clearBtn.style.display = q ? 'flex' : 'none';

    const grid = document.getElementById('grid');
    if (!grid) return;

    let visible = 0;
    grid.querySelectorAll('.card').forEach(card => {
      const name = card.dataset.name || '';
      const match = q === '' || name.includes(q);
      if (match) {
        card.classList.remove('hidden');
        const el = card.querySelector('.font-name');
        if (el) el.innerHTML = highlight(name, q);
        visible++;
      } else {
        card.classList.add('hidden');
      }
    });

    resultsCount.textContent = q ? `${visible} خط` : '';
    noResults.style.display = visible === 0 && q ? 'block' : 'none';
    if (q) searchTermEl.textContent = q;
  }

  searchInput.addEventListener('input', doSearch);
  clearBtn.addEventListener('click', () => { searchInput.value = ''; doSearch(); searchInput.focus(); });

  /* ── Load Fonts ── */
  async function loadFonts() {
    const content = document.getElementById('content');
    try {
      const snap = await getDocs(query(collection(db, 'fonts'), orderBy('createdAt','desc')));
      if (snap.empty) {
        content.innerHTML = '<p class="empty">لا توجد خطوط منشورة بعد</p>';
        return;
      }

      const grid = document.createElement('div');
      grid.className = 'grid'; grid.id = 'grid';

      snap.forEach((docSnap, i) => {
        const d = docSnap.data();
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.name = d.name;
        card.style.animationDelay = `${i * 0.07}s`;
        card.innerHTML = `
          <img src="${d.posterBase64}" alt="${d.name}" loading="lazy"/>
          <div class="card-body">
            <span class="font-name">${d.name}</span>
            <button class="download-btn" data-href="${d.fileBase64}" data-name="${d.name}" data-filename="${d.fileName}">
              <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              تحميل
            </button>
          </div>`;
        grid.appendChild(card);
      });

      content.innerHTML = '';
      content.appendChild(grid);

      grid.addEventListener('click', e => {
        const btn = e.target.closest('.download-btn');
        if (!btn) return;
        openModal(btn.dataset.name, btn.dataset.href, btn.dataset.filename);
      });

    } catch(e) {
      content.innerHTML = '<p class="empty">حدث خطأ في التحميل</p>';
      console.error(e);
    }
  }

  loadFonts();
</script>
</body>
</html>
